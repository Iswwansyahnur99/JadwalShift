<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Shift Pemancar Transmisi TVRI Kaltara</title>
    <link rel="icon" href="photos/logo_tvri_kaltara.png" type="image/png">
    <style>
        /* --- CSS Variables for Theming (Light and Dark Mode) --- */
        :root {
            /* Light Mode Colors - Inspired by TVRI Blue (#00508C) & Red (#DC2F2F) */
            --bg-color: #e6f0f5; 
            --container-bg: rgba(255, 255, 255, 0.65); /* MAGIC: Glassmorphism base */
            --text-color: #2c3e50;
            --primary-blue: #005b9a; 
            --secondary-red: #e74c3c;
            --card-bg: rgba(245, 250, 253, 0.85);
            --card-border: rgba(0, 91, 154, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --border-light: rgba(0, 91, 154, 0.15);
            --sub-heading-color: #00406d;
            --empty-msg-bg: #f9f9f9;
            --empty-msg-color: #7f8c8d;
            --popup-overlay-bg: rgba(0, 0, 0, 0.7);
            --popup-bg: #ffffff;
            --popup-text-color: #333;
            --active-shift-bg: var(--primary-blue);
            --active-shift-text: white;
            --active-shift-border: #003a66;
            --active-shift-glow: 0 0 15px rgba(0, 91, 154, 0.7);
            --progress-bar-track: rgba(0, 0, 0, 0.1);
            --progress-bar-fill: linear-gradient(90deg, #e74c3c, #c0392b); /* MAGIC: Gradient progress bar */
            --progress-bar-text: #555;
        }

        /* --- Dark Mode Colors --- */
        body.dark-mode {
            --container-bg: rgba(45, 45, 45, 0.65); /* MAGIC: Dark Glassmorphism */
            --text-color: #ecf0f1;
            --primary-blue: #5dade2; 
            --secondary-red: #f1948a;
            --card-bg: rgba(60, 60, 60, 0.85);
            --card-border: rgba(93, 173, 226, 0.3);
            --shadow-color: rgba(0, 0, 0, 0.4);
            --border-light: rgba(93, 173, 226, 0.2);
            --sub-heading-color: #a9cce3;
            --empty-msg-bg: #3a3a3a;
            --empty-msg-color: #bdc3c7;
            --popup-overlay-bg: rgba(0, 0, 0, 0.9);
            --popup-bg: #3a3a3a;
            --popup-text-color: #e0e0e0;
            --active-shift-bg: var(--primary-blue);
            --active-shift-text: #2d2d2d;
            --active-shift-border: #3a7fa5;
            --active-shift-glow: 0 0 15px rgba(93, 173, 226, 0.7);
            --progress-bar-track: rgba(255, 255, 255, 0.15);
            --progress-bar-fill: linear-gradient(90deg, #f1948a, #e74c3c);
            --progress-bar-text: #ccc;
        }

        /* --- Global Styles --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.5s ease, color 0.5s ease, background-image 1s ease-in-out;
            background-size: cover;
            background-attachment: fixed;
            background-position: center center;
        }
        
        /* MAGIC: Time-based background images */
        body.day { background-image: url('https://source.unsplash.com/random/1600x900/?bright,control-room'); }
        body.morning { background-image: url('https://source.unsplash.com/random/1600x900/?sunrise,studio,morning'); }
        body.afternoon { background-image: url('https://source.unsplash.com/random/1600x900/?afternoon,broadcasting'); }
        body.night { background-image: url('https://source.unsplash.com/random/1600x900/?night,studio,dark'); }

        /* --- Main Containers & Glassmorphism --- */
        .main-content-wrapper {
            max-width: 700px; /* Increased width */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container, .schedule-visualization-container, .currently-on-duty-container {
            background-color: var(--container-bg);
            padding: 30px;
            box-shadow: 0 8px 32px 0 var(--shadow-color); /* Enhanced shadow */
            backdrop-filter: blur(12px); /* MAGIC: The blur effect */
            -webkit-backdrop-filter: blur(12px); /* For Safari */
            border: 1px solid var(--card-border);
            width: 100%;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            position: relative;
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
        }
        .main-content-wrapper > .container:first-of-type { border-radius: 0 0 15px 15px; animation-delay: 0.1s; }
        .schedule-visualization-container { border-radius: 15px; animation-delay: 0.3s; }
        .currently-on-duty-container { border-radius: 15px; animation-delay: 0.2s; }

        /* --- Navigation Bar --- */
        .navbar {
            background-color: var(--primary-blue);
            width: 100%;
            max-width: 700px;
            border-radius: 15px 15px 0 0;
            padding: 10px 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
            gap: 20px;
            position: relative;
            animation: fadeInUp 0.5s ease-out forwards;
        }
        .navbar a { color: white; text-decoration: none; padding: 10px 20px; border-radius: 10px; transition: background-color 0.2s ease, transform 0.2s ease; font-weight: bold; }
        .navbar a:hover { background-color: var(--sub-heading-color); transform: translateY(-2px); }
        .navbar a.active-nav { background-color: var(--sub-heading-color); box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }

        /* --- Header Section --- */
        .container .header { padding-top: 15px; margin-bottom: 20px; }
        #tvriKaltaraLogo { width: 85px; margin-bottom: 15px; transition: transform 0.3s ease; }
        body.dark-mode #tvriKaltaraLogo { content: url('photos/logo_tvri_kaltara_dark_mode.png'); }
        #tvriKaltaraLogo:hover { transform: scale(1.1) rotate(-5deg); }
        h1 { color: var(--primary-blue); margin-bottom: 15px; font-size: 2.4em; }
        .dynamic-greeting { font-size: 1.4em; font-weight: bold; color: var(--sub-heading-color); margin-bottom: 20px; }
        .datetime-display { font-size: 1.1em; font-weight: 600; color: var(--text-color); margin-bottom: 25px; line-height: 1.6; }

        /* --- Countdown Progress Bar --- */
        .countdown-progress-bar { background-color: var(--progress-bar-track); border-radius: 15px; height: 12px; overflow: hidden; position: relative; }
        .countdown-progress-fill { background: var(--progress-bar-fill); height: 100%; width: 0%; border-radius: 15px; transition: width 1s linear; background-size: 200% 100%; animation: gradient-animation 3s ease infinite; }
        .countdown-progress-text { font-size: 1em; color: var(--progress-bar-text); margin-top: 10px; font-weight: bold; }

        /* --- Currently On Duty Section --- */
        .currently-on-duty-container h2 { font-size: 1.8em; }
        .on-duty-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 20px; margin-top: 20px; }
        .on-duty-card { background-color: var(--card-bg); padding: 20px; border-radius: 12px; color: var(--text-color); box-shadow: 0 4px 10px rgba(0,0,0,0.07); cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; text-align: center; }
        .on-duty-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.15); }
        .on-duty-photo { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 4px solid var(--container-bg); box-shadow: 0 0 10px rgba(0,0,0,0.15); }
        .on-duty-name { font-weight: bold; font-size: 1em; margin-top: 10px; }
        .no-one-on-duty { font-style: italic; color: var(--empty-msg-color); padding: 20px; background-color: var(--card-bg); border-radius: 10px; }

        /* --- UX UPGRADE: Schedule Visualization Timeline --- */
        .schedule-visualization-container h2 { font-size: 2.2em; border-bottom: 2px solid var(--border-light); padding-bottom: 15px; }
        #schedule-timeline-wrapper { position: relative; width: 100%; height: 120px; background-color: var(--card-bg); border-radius: 10px; margin-top: 30px; border: 1px solid var(--card-border); overflow: hidden; }
        .shift-block { position: absolute; height: 100%; top: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 10px; text-align: center; border-right: 1px solid var(--card-border); transition: all 0.4s ease; cursor: pointer; }
        .shift-block.active-shift { background-color: var(--active-shift-bg); color: var(--active-shift-text); box-shadow: var(--active-shift-glow); z-index: 5; transform: scale(1.05); }
        .shift-block .shift-title { font-weight: bold; font-size: 1.2em; }
        .shift-block .shift-time { font-size: 0.8em; opacity: 0.8; }
        .shift-block .personnel-preview { font-size: 0.85em; margin-top: 8px; max-width: 90%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #current-time-indicator { position: absolute; top: 0; left: 0; width: 3px; height: 100%; background-color: var(--secondary-red); z-index: 10; transition: left 1s linear; box-shadow: 0 0 10px var(--secondary-red); }
        #current-time-indicator::after { content: ''; position: absolute; top: -5px; left: -5px; width: 13px; height: 13px; background-color: var(--secondary-red); border-radius: 50%; border: 2px solid white; }

        /* --- Popups & FAB --- */
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--popup-overlay-bg); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s; backdrop-filter: blur(5px); }
        .popup-overlay.active { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .popup-content { background-color: var(--popup-bg); padding: 30px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3); max-width: 400px; width: 90%; text-align: center; position: relative; transform: scale(0.9) translateY(20px); transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); color: var(--popup-text-color); }
        .popup-overlay.active .popup-content { transform: scale(1) translateY(0); }
        .popup-close { position: absolute; top: 15px; right: 15px; font-size: 30px; cursor: pointer; transition: color 0.2s ease, transform 0.2s ease; }
        .popup-close:hover { color: var(--secondary-red); transform: rotate(90deg); }
        .call-bantuan-button { position: fixed; bottom: 25px; right: 25px; background-color: var(--secondary-red); color: white; border: none; border-radius: 50%; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: all 0.3s ease; z-index: 999; }
        .call-bantuan-button:hover { background-color: #c0392b; transform: translateY(-3px) scale(1.1); }
        
        /* --- General Animations --- */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes gradient-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* --- Theme Switch --- */
        .theme-switch-wrapper { display: flex; align-items: center; justify-content: flex-end; margin-bottom: 20px; width: 100%; max-width: 700px; padding: 0 10px; animation: fadeInUp 0.5s ease-out forwards; animation-delay: 0.4s; opacity:0; }
        .theme-switch { display: inline-block; height: 34px; position: relative; width: 60px; }
        .theme-switch input { display: none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 26px; left: 4px; position: absolute; transition: .4s; width: 26px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-blue); }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        .theme-switch-wrapper span { margin-right: 10px; font-size: 0.9em; color: var(--text-color); }
        
        /* Other shared popup styles are assumed to be similar to the original */
        .popup-image { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; object-position: center center; margin-bottom: 15px; border: 4px solid var(--primary-blue); }
        .popup-name { font-size: 1.8em; font-weight: bold; color: var(--primary-blue); margin-bottom: 8px; }
        .popup-info { font-size: 1.1em; color: var(--popup-text-color); }
        .popup-contact-links { margin-top: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .popup-contact-links a { display: inline-flex; align-items: center; padding: 10px 15px; border-radius: 8px; text-decoration: none; color: white; font-size: 1em; font-weight: bold; transition: opacity 0.2s ease, transform 0.2s ease; }
        .popup-contact-links a:hover { opacity: 0.85; transform: translateY(-2px); }
        .popup-contact-links .phone-link { background-color: #3498db; }
        .popup-contact-links .whatsapp-link { background-color: #2ecc71; }
        .popup-contact-links a svg { margin-right: 8px; width: 18px; height: 18px; fill: white; }
    </style>
</head>
<body class="light-mode">
    <div class="theme-switch-wrapper">
        <span>Dark Mode</span>
        <label class="theme-switch" for="checkbox">
            <input type="checkbox" id="checkbox" />
            <div class="slider round"></div>
        </label>
    </div>

    <div class="main-content-wrapper">
        <nav class="navbar">
            <a href="index.html" class="active-nav">Jadwal Harian</a>
            <a href="search.html">Cari Jadwal Saya</a>
        </nav>

        <div class="container"> 
            <div class="header">
                <img id="tvriKaltaraLogo" alt="Logo TVRI Kaltara" class="logo">
                <h1>Shift Pemancar Siaran TVRI Kaltara</h1>
                <p class="dynamic-greeting" id="dynamicGreeting"></p>
            </div>
            <div class="datetime-display" id="currentDateTime"></div>
            <div class="countdown-progress-container">
                <div class="countdown-progress-bar">
                    <div class="countdown-progress-fill" id="countdownProgressBarFill"></div>
                </div>
                <p class="countdown-progress-text" id="countdownProgressText">Loading countdown...</p>
            </div>
        </div>

        <div class="currently-on-duty-container">
            <h2>Saat Ini Bertugas <span class="shift-name-display" id="currentShiftNameDisplay"></span></h2>
            <div class="on-duty-grid" id="onDutyGrid">
            </div>
        </div>
        
        <div class="schedule-visualization-container"> 
            <h2 id="scheduleDateHeader">Memuat Jadwal...</h2>
            <div id="schedule-timeline-wrapper">
                 <div id="current-time-indicator"></div>
                 </div>
        </div>
    </div> 
    
    <div class="popup-overlay" id="photoPopupOverlay">
        <div class="popup-content">
            <button class="popup-close" id="popupCloseBtn">&times;</button>
            <img src="" alt="Foto Karyawan" class="popup-image" id="popupImage">
            <p class="popup-name" id="popupName"></p>
            <p class="popup-info" id="popupInfo"></p>
            <div class="popup-contact-links" id="popupContactLinks"></div>
        </div>
    </div>

    <button class="call-bantuan-button" id="callBantuanBtn">
        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#FFFFFF"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-2.45c0-.54-.45-.99-.99-.99z"/></svg>
    </button>

    <div class="popup-overlay" id="callBantuanPopupOverlay">
        <div class="popup-content call-bantuan-popup-content">
            <button class="popup-close" id="callBantuanCloseBtn">&times;</button>
            <h3>Bantuan Darurat / Kontak Penting</h3>
            <ul id="contactList"></ul>
        </div>
    </div>

    <script>
        // All JS logic is largely the same, with updates to rendering functions.
        // The original script can be pasted here, with the following functions MODIFIED or ADDED.
        let fullScheduleData = null;

        const shiftTimes = {
            "shift1": { start: 8, end: 16, display: "Shift 1" },
            "shift2": { start: 16, end: 24, display: "Shift 2" },
            "shift3": { start: 0, end: 8, display: "Shift 3" }
        };
        const allShiftKeys = ["shift3", "shift1", "shift2"]; // Chronological order
        const allDays = ["MINGGU", "SENIN", "SELASA", "RABU", "KAMIS", "JUMAT", "SABTU"];

        const emergencyContacts = [
            { role: "Ketua TIM Teknik", name: "Pak Afif", phone: "0813-4754-0304" },
            { role: "Kasubag Umum", name: "Pak Ari", phone: "0812-4775-7937" },
            { role: "Kepsta", name: "Pak Agung", phone: "0813-2147-7645" }
        ];

        let lastActiveShiftKey = null;

        async function fetchScheduleData() {
            try {
                const response = await fetch('jadwal.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                fullScheduleData = data.karyawan;
                return fullScheduleData;
            } catch (error) {
                console.error("Could not fetch schedule data:", error);
                document.getElementById('scheduleDateHeader').textContent = "Gagal memuat jadwal.";
                const onDutyGrid = document.getElementById('onDutyGrid');
                if (onDutyGrid) onDutyGrid.innerHTML = `<p class="no-one-on-duty">Gagal memuat data petugas.</p>`;
                return null;
            }
        }

        function getNamaHari(date) { return allDays[date.getDay()]; }

        function getCurrentShiftInfo(hour) {
            if (hour >= shiftTimes.shift1.start && hour < shiftTimes.shift1.end) return { key: "shift1", name: shiftTimes.shift1.display, index: 1 };
            else if (hour >= shiftTimes.shift2.start && hour < shiftTimes.shift2.end) return { key: "shift2", name: shiftTimes.shift2.display, index: 2 };
            else return { key: "shift3", name: shiftTimes.shift3.display, index: 0 };
        }

        function getJagaList(dayName, shiftKey, scheduleData) {
            const jagaNames = [];
            if (!scheduleData) return jagaNames;
            for (const nama in scheduleData) {
                const jadwalOrang = scheduleData[nama];
                if (jadwalOrang.shift?.[dayName]?.[shiftKey] === "jaga") {
                    jagaNames.push(nama);
                }
            }
            return jagaNames;
        }
        
        function updateDateTimeDisplay() {
            const now = new Date();
            const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Asia/Makassar' };
            const optionsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'Asia/Makassar' };
            const currentDate = new Intl.DateTimeFormat('id-ID', optionsDate).format(now);
            const currentTime = new Intl.DateTimeFormat('id-ID', optionsTime).format(now);
            document.getElementById('currentDateTime').innerHTML = `${currentDate}<br>${currentTime} WITA`;
        }

        function displayDynamicGreeting() {
            const now = new Date();
            const hourWITA = parseInt(new Intl.DateTimeFormat('en-US', { hour: '2-digit', hourCycle: 'h23', timeZone: 'Asia/Makassar' }).format(now));
            let greeting = "";
            let bodyClass = "";
            let icon = "";
            if (hourWITA >= 5 && hourWITA < 12) { greeting = "Pagi Cerah, Semangat Melimpah!"; bodyClass = "morning"; icon = "â˜€ï¸"; }
            else if (hourWITA >= 12 && hourWITA < 15) { greeting = "Siang Hangat, Kerja Semangat"; bodyClass = "day"; icon = "ðŸ˜Ž"; }
            else if (hourWITA >= 15 && hourWITA < 18) { greeting = "Sore Teduh, Semangat Penuh!"; bodyClass = "afternoon"; icon = "ðŸŒ‡"; }
            else { greeting = "Malam Nyaman, Semangat Aman!"; bodyClass = "night"; icon = "ðŸŒ™"; }
            document.getElementById('dynamicGreeting').textContent = `${icon} ${greeting}`;
            document.body.className = (document.body.classList.contains('dark-mode') ? 'dark-mode ' : 'light-mode ') + bodyClass;
        }

        function updateCountdownProgressBar() {
            // This function's logic remains the same as the original.
            // ... (original function code)
            const nowWITA = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Makassar' }));
            const hourWITA = nowWITA.getHours();
            const minuteWITA = nowWITA.getMinutes();
            const secondWITA = nowWITA.getSeconds();

            const currentShiftInfo = getCurrentShiftInfo(hourWITA);
            const currentShiftConfig = shiftTimes[currentShiftInfo.key];

            let totalShiftDurationSeconds;
            if (currentShiftInfo.key === "shift3") { 
                totalShiftDurationSeconds = 8 * 3600; // 00:00 to 08:00
            } else if (currentShiftInfo.key === "shift2"){
                totalShiftDurationSeconds = (24 - currentShiftConfig.start) * 3600; // 16:00 to 24:00
            } else { // shift1
                 totalShiftDurationSeconds = (currentShiftConfig.end - currentShiftConfig.start) * 3600;
            }

            const currentTimeInSecondsToday = hourWITA * 3600 + minuteWITA * 60 + secondWITA;
            let elapsedShiftDurationSeconds = currentTimeInSecondsToday - (currentShiftConfig.start * 3600);

            if (currentShiftInfo.key === "shift3" && currentShiftConfig.start === 0) { // For shift 00:00-08:00
                 elapsedShiftDurationSeconds = currentTimeInSecondsToday;
            }
            
            let progressPercentage = (elapsedShiftDurationSeconds / totalShiftDurationSeconds) * 100;
            progressPercentage = Math.max(0, Math.min(100, progressPercentage)); 

            document.getElementById('countdownProgressBarFill').style.width = `${progressPercentage}%`;

            const shiftKeysForCountdown = ["shift1", "shift2", "shift3"];
            const currentShiftIndex = shiftKeysForCountdown.indexOf(currentShiftInfo.key);
            let nextShiftKey = shiftKeysForCountdown[(currentShiftIndex + 1) % shiftKeysForCountdown.length];
            let nextShiftStartTime = shiftTimes[nextShiftKey].start;
            
            let nextShiftDateObj = new Date(nowWITA);
            nextShiftDateObj.setHours(nextShiftStartTime, 0, 0, 0);

            if(currentShiftInfo.key === 'shift2'){ // Special case for shift 2, next is shift 3 tomorrow
                 nextShiftDateObj.setDate(nextShiftDateObj.getDate() + 1);
            }
            
            let timeToNextShiftMs = nextShiftDateObj.getTime() - nowWITA.getTime();
            if(timeToNextShiftMs < 0 && currentShiftInfo.key !== 'shift2'){
                 // This handles the transition for shift 3 -> 1 and 1 -> 2
                 timeToNextShiftMs = (shiftTimes[nextShiftKey].start * 3600 * 1000) - (nowWITA.getTime() % (24 * 3600 * 1000));
            }
             if(timeToNextShiftMs < 0) { // Catch all for next day
                  nextShiftDateObj.setDate(nextShiftDateObj.getDate() + 1);
                  timeToNextShiftMs = nextShiftDateObj.getTime() - nowWITA.getTime();
             }

            const totalSecondsRemaining = Math.floor(timeToNextShiftMs / 1000);
            const hours = Math.floor(totalSecondsRemaining / 3600);
            const minutes = Math.floor((totalSecondsRemaining % 3600) / 60);
            const seconds = totalSecondsRemaining % 60;

            let countdownText;
            if (progressPercentage < 1 && elapsedShiftDurationSeconds >=0 && elapsedShiftDurationSeconds < 60 ) { 
                 countdownText = `Shift ${shiftTimes[currentShiftInfo.key].display} Baru Saja Dimulai!`;
            } else {
                 countdownText = `Shift ${shiftTimes[nextShiftKey].display} dimulai dalam ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            document.getElementById('countdownProgressText').textContent = countdownText;
        }

        // MODIFIED: Display on-duty personnel
        function displayCurrentlyOnDuty(currentShiftInfoToDisplay) {
            // Logic is largely the same, but with updated class names and structure if needed.
             if (!fullScheduleData || !currentShiftInfoToDisplay) return;
            const onDutyGrid = document.getElementById('onDutyGrid');
            const currentShiftNameDisplay = document.getElementById('currentShiftNameDisplay');
            onDutyGrid.innerHTML = ''; 
            currentShiftNameDisplay.textContent = `(${currentShiftInfoToDisplay.name})`;
            const namaHariJadwal = getNamaHari(new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Makassar' })));
            const jagaNames = getJagaList(namaHariJadwal, currentShiftInfoToDisplay.key, fullScheduleData);

            if (jagaNames.length > 0) {
                jagaNames.forEach(nama => {
                    const employeeData = fullScheduleData[nama];
                    const photoSrc = (employeeData?.photo) ? employeeData.photo : 'https://via.placeholder.com/150?text=No+Photo';
                    const card = document.createElement('div');
                    card.className = 'on-duty-card';
                    card.innerHTML = `<img src="${photoSrc}" alt="Foto ${nama}" class="on-duty-photo"><span class="on-duty-name">${nama}</span>`;
                    card.addEventListener('click', () => showPhotoPopup(nama, fullScheduleData));
                    onDutyGrid.appendChild(card);
                });
            } else {
                onDutyGrid.innerHTML = `<p class="no-one-on-duty">Tidak ada yang bertugas pada shift ini.</p>`;
            }
        }

        // UX UPGRADE: Replaces displayFullDayScheduleVisualization
        function displayFullDayTimeline(currentShiftInfo) {
            if (!fullScheduleData || !currentShiftInfo) return;

            const nowForDay = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Makassar' }));
            const namaHariJadwal = getNamaHari(nowForDay);
            const formattedDateForHeader = new Intl.DateTimeFormat('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', timeZone: 'Asia/Makassar' }).format(nowForDay);
            document.getElementById('scheduleDateHeader').textContent = `Timeline Jaga ${formattedDateForHeader}`;
            
            const timelineWrapper = document.getElementById('schedule-timeline-wrapper');
            // Clear only shift blocks, not the time indicator
            timelineWrapper.querySelectorAll('.shift-block').forEach(el => el.remove());

            allShiftKeys.forEach(shiftKey => {
                const shift = shiftTimes[shiftKey];
                const shiftStartHour = shift.start;
                const shiftEndHour = shift.end === 24 ? 24 : shift.end;
                
                // For Shift 3 (00:00 - 08:00), it spans across midnight. 
                // In a 24h timeline, it's just the first block.
                const durationHours = (shiftEndHour - shiftStartHour + 24) % 24 || (shift.end === 8 && shift.start === 0 ? 8 : 0);

                const widthPercent = (durationHours / 24) * 100;
                const leftPercent = (shiftStartHour / 24) * 100;

                const shiftBlock = document.createElement('div');
                shiftBlock.className = 'shift-block';
                shiftBlock.style.left = `${leftPercent}%`;
                shiftBlock.style.width = `${widthPercent}%`;
                if(shiftKey === currentShiftInfo.key) {
                    shiftBlock.classList.add('active-shift');
                }
                
                const jagaNames = getJagaList(namaHariJadwal, shiftKey, fullScheduleData);
                const personnelText = jagaNames.length > 0 ? jagaNames.join(', ') : 'Tidak ada jaga';

                shiftBlock.innerHTML = `
                    <div class="shift-title">${shift.display}</div>
                    <div class="shift-time">${String(shift.start).padStart(2,'0')}:00 - ${String(shift.end === 24 ? 0 : shift.end).padStart(2,'0')}:00</div>
                    <div class="personnel-preview">${personnelText}</div>
                `;
                timelineWrapper.appendChild(shiftBlock);
            });
            updateTimeIndicator();
        }

        // NEW: Function to update the time indicator on the timeline
        function updateTimeIndicator() {
            const nowWITA = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Makassar' }));
            const totalSecondsInDay = 24 * 60 * 60;
            const secondsPastMidnight = nowWITA.getHours() * 3600 + nowWITA.getMinutes() * 60 + nowWITA.getSeconds();
            const percentOfDay = (secondsPastMidnight / totalSecondsInDay) * 100;
            
            document.getElementById('current-time-indicator').style.left = `${percentOfDay}%`;
        }
        
        // --- Theme Switch and Popup Logic (Identical to original) ---
        const toggleSwitch = document.getElementById('checkbox');
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme) { document.body.classList.add(currentTheme); if (currentTheme === 'dark-mode') toggleSwitch.checked = true; } 
        function switchTheme(e) { 
            const isChecked = e.target.checked;
            document.body.classList.toggle('dark-mode', isChecked);
            document.body.classList.toggle('light-mode', !isChecked);
            localStorage.setItem('theme', isChecked ? 'dark-mode' : 'light-mode');
            displayDynamicGreeting(); // Re-apply background class
        }
        toggleSwitch.addEventListener('change', switchTheme, false);
        // ... (All popup functions: showPhotoPopup, hidePopup, showCallBantuanPopup, and their event listeners can be pasted from the original script)
        const photoPopupOverlay = document.getElementById('photoPopupOverlay');
        const popupImage = document.getElementById('popupImage');
        const popupName = document.getElementById('popupName');
        const popupInfo = document.getElementById('popupInfo');
        const popupContactLinks = document.getElementById('popupContactLinks');
        const popupCloseBtn = document.getElementById('popupCloseBtn');

        function showPhotoPopup(nama, scheduleData) { 
            const employeeData = scheduleData[nama]; 
            if (employeeData) {
                popupImage.src = employeeData.photo || 'https://via.placeholder.com/150?text=No+Photo';
                popupImage.alt = `Foto ${nama}`;
                popupName.textContent = nama;
                popupInfo.textContent = employeeData.info || "Informasi tidak tersedia.";
                popupContactLinks.innerHTML = ''; 
                if (employeeData.phone) {
                    const phoneLink = document.createElement('a');
                    phoneLink.href = `tel:${employeeData.phone}`;
                    phoneLink.className = 'phone-link';
                    phoneLink.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.02.75-.24 1.02l-2.2 2.2z"/></svg>Telepon`;
                    popupContactLinks.appendChild(phoneLink);
                }
                if (employeeData.whatsapp) {
                    const whatsappLink = document.createElement('a');
                    whatsappLink.href = `https://wa.me/${employeeData.whatsapp}`;
                    whatsappLink.target = "_blank";
                    whatsappLink.className = 'whatsapp-link';
                    whatsappLink.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M16.75 13.96c.25.13.41.38.41.66v1.38c0 .55-.45 1-1 1-1.33 0-2.6-.35-3.76-.95-.2-.1-.43-.09-.62.04-1.46.99-3.13 1.54-4.88 1.54-4.97 0-9-4.03-9-9s4.03-9 9-9 9 4.03 9 9c0 1.79-.53 3.5-1.48 4.95-.14.22-.13.51.02.71l.83.99c.19.22.49.29.76.17.9-.41 1.71-.97 2.41-1.66.04-.04.08-.08.13-.12.56-.56 1.03-1.2 1.42-1.89.04-.07.08-.14.11-.21.28-.6.5-1.25.64-1.93.02-.09.04-.19.05-.28.16-.9.24-1.82.24-2.75 0-6.08-4.92-11-11-11S1 4.92 1 11s4.92 11 11 11c1.55 0 3.05-.32 4.44-.92.26-.11.55-.05.75.14l1.56 1.56z"/></svg>WhatsApp`;
                    popupContactLinks.appendChild(whatsappLink);
                }
                photoPopupOverlay.classList.add('active');
            }
        }
        function hidePopup(popupElement) {
            popupElement.classList.remove('active');
            if (popupElement === photoPopupOverlay) {
                setTimeout(() => { popupImage.src = ""; }, 300); 
                document.getElementById('popupContactLinks').innerHTML = ''; 
            }
        }
        photoPopupOverlay.addEventListener('click', (e) => { if (e.target === photoPopupOverlay) hidePopup(photoPopupOverlay); });
        popupCloseBtn.addEventListener('click', () => hidePopup(photoPopupOverlay));
        const callBantuanBtn = document.getElementById('callBantuanBtn');
        const callBantuanPopupOverlay = document.getElementById('callBantuanPopupOverlay');
        const callBantuanCloseBtn = document.getElementById('callBantuanCloseBtn');
        const contactList = document.getElementById('contactList');
        function showCallBantuanPopup() {
            contactList.innerHTML = '';
            emergencyContacts.forEach(contact => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${contact.role}:</strong> ${contact.name} (<a href="tel:${contact.phone}">${contact.phone}</a>)`;
                contactList.appendChild(li);
            });
            callBantuanPopupOverlay.classList.add('active');
        }
        callBantuanBtn.addEventListener('click', showCallBantuanPopup);
        callBantuanCloseBtn.addEventListener('click', () => hidePopup(callBantuanPopupOverlay));
        callBantuanPopupOverlay.addEventListener('click', (e) => { if (e.target === callBantuanPopupOverlay) hidePopup(callBantuanPopupOverlay); });

        // MODIFIED: Main application loop
        async function initializeApp() {
            await fetchScheduleData(); 
            updateDateTimeDisplay(); 
            displayDynamicGreeting(); 
            
            const initialNow = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Makassar' }));
            const initialHourWITA = initialNow.getHours();
            const initialCurrentShiftInfo = getCurrentShiftInfo(initialHourWITA);
            lastActiveShiftKey = initialCurrentShiftInfo.key;

            if(fullScheduleData){ 
                displayCurrentlyOnDuty(initialCurrentShiftInfo); 
                displayFullDayTimeline(initialCurrentShiftInfo); // UX UPGRADE
            }
            
            updateCountdownProgressBar(); 

            setInterval(() => {
                updateDateTimeDisplay();
                updateCountdownProgressBar();
                updateTimeIndicator(); // UX UPGRADE
            }, 1000);

            // This interval can be less frequent
            setInterval(() => {
                displayDynamicGreeting();
                if(fullScheduleData){
                    const now = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Makassar' }));
                    const hourWITA = now.getHours();
                    const currentShiftInfo = getCurrentShiftInfo(hourWITA);
                    
                    // Update schedule displays only when the shift changes
                    if (lastActiveShiftKey !== currentShiftInfo.key) {
                        displayCurrentlyOnDuty(currentShiftInfo);
                        displayFullDayTimeline(currentShiftInfo); // UX UPGRADE
                        lastActiveShiftKey = currentShiftInfo.key;
                    }
                }
            }, 60 * 1000); 
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
